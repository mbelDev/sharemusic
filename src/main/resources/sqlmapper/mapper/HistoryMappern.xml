<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.music.sharemusic.dao.HistoryDao">

  <select id="getHistoryRecent" parameterType="String" resultType="HistoryDto">
    SELECT * FROM HISTORY WHERE USERID = #{userID} ORDER BY READDATE DESC
  </select>
  <select id="getHistoryLike" parameterType="String" resultType="HistoryDto">
    SELECT * FROM HISTORY WHERE USERID = #{userID} AND POSTLIKE = 1 ORDER BY READDATE DESC
  </select>
  <select id="getHistoryBookmark" parameterType="String" resultType="HistoryDto">
    SELECT * FROM HISTORY WHERE USERID = #{userID} AND BOOKMARK = 1 ORDER BY READDATE DESC
  </select>
  <select id="getHistoryOne" parameterType="LoggedDto" resultType="Integer">
    SELECT COUNT(*) AS TOTAL FROM HISTORY WHERE USERID = #{userID} AND POSTNO = #{postNo}
  </select>

  <select id="getHistoryBoard" parameterType="HistoryDto" resultType="BoardDto">
    SELECT * FROM BOARD a, HISTORY b WHERE a.POSTNO = b.POSTNO
  </select>

<insert id="putHistory" parameterType="LoggedDto">
    INSERT INTO HISTORY (USERID, POSTNO, POSTAUTH, POSTTITLE, READDATE, LIKED, BOOKMARK) 
    VALUES (#{userID}, #{postNo}, (SELECT POSTAUTH FROM BOARD WHERE POSTNO = #{postNo}),(SELECT POSTTITLE FROM BOARD WHERE POSTNO = #{postNo}), SYSTIMESTAMP, 0, 0)
</insert>

  <update id="updateHistoryDate" parameterType="LoggedDto">
    UPDATE HISTORY SET
    READDATE = SYSTIMESTAMP WHERE USERID = #{userID} AND POSTNO = #{postNo}
  </update>

  <update id="updateHistoryLike" parameterType="LoggedDto">
    UPDATE HISTORY SET
    <choose>
        <when test='POSTLIKE == 0'>POSTLIKE = 1 </when>
        <otherwise> POSTLIKE = 0 </otherwise>
    </choose>
    WHERE USERID = #{userID} AND POSTNO = #{postNo}
  </update>

  <delete id="deleteHistoryAll" parameterType="String">
    DELETE FROM HISTORY WHERE USERID = #{userID}
  </delete>

  <delete id="deleteHistoryOne" parameterType="Map">
    DELETE FROM HISTORY WHERE USERID = #{userID} AND POSTNO = #{postNo}
  </delete>


  <select id="test" resultType="int">
    SELECT COUNT(*) AS TOTAL FROM HISTORY WHERE USERID = 'gundam'
  </select>
</mapper>  
