<!DOCTYPE html>
<html
  lang="en"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  xmlns:th="http://www.thymeleaf.org"
  layout:decorate="~{/include/layout.html}"
>
  <main id="mainPage-Area" class="" layout:fragment="contents">
    <section class="boardView">
      <!--------------------------------------------------[             본문 표시 창            ]-------------------------------------------------------------------------->
      <!--------------------------------------------------[            boardView-Area          ]-------------------------------------------------------------------------->
      <article class="boardView-Area">
        <div class="boardView-Area-title topAndbut">
          <h1>VIDEO</h1>
        </div>
        <!-- boardView-Area-title -->
        <div class="boardView-Video">
          <iframe
            th:src="'https://www.youtube.com/embed/' + ${boardDto.postLink}+'?&controls=0&autohide=0&rel=0'"
            frameborder="0"
            allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen
          >
          </iframe>
          <div class="boardView-Video--title">
            <div class="title">
              <div class="title-name">
                <p th:text="${boardDto.postTitle}">곡이름</p>
                <a th:href="@{/mainPage/(searchTxt=${boardDto.postSinger})}">
                  <h1 th:text="${boardDto.postSinger}">가수</h1>
                </a>
              </div>
              <!-- title-name -->
              <div class="title-Date">
                등록&nbsp;&nbsp;
                <span th:text="${boardDto.postDate}">0</span>
                &nbsp;&nbsp;&nbsp;*&nbsp;&nbsp; 조회수&nbsp;&nbsp;
                <span th:text="${boardDto.postHits}">0</span>
              </div>
              <!-- title-Date -->
              <div class="title-Genre">
                <span th:text="'#' + ${boardDto.postGenre}">장르</span>
                <span th:text="'#' + ${boardDto.postEmote}">감성</span>
              </div>
              <!-- title-Genre -->
              <div
                class="title-btn"
                th:if="${session.loggedUser != null} and ${session.loggedUser.userNM == boardDto.postAuth}"
              >
                <a
                  href="/board/modify"
                  th:href="@{/board/modify(postNo=${boardDto.postNo})}"
                  class="btn btn-primary"
                  >수정</a
                >
                <button id="deleteModalBox" class="btn btn-secondary">
                  삭제
                </button>
              </div>
              <!-- title-btn -->
            </div>
            <!-- title -->
            <div class="like">
              <div class="like-good">
                <img
                  class="good-img"
                  src="/images/good.svg"
                  onclick="updateLike('.good-img');"
                  th:data-postno="${boardDto.postNo}"
                  data-liked=""
                />
                <!--  <<<<<<<<<<<<<<  좋아요 버튼     -->
                <span th:text="${boardDto.postLike}" class="postLike">0</span>
              </div>
              <!-- like-good -->
              <div class="like-btn">
                <button class="btnOpen btnShare" id="shareModalBox">
                  <img src="/images/open.svg" alt="" />
                </button>
              </div>
              <!-- like-btn -->
            </div>
            <!-- like -->
          </div>
          <!-- boardView-Video--title -->
        </div>
        <!-- boardView-Video -->
      </article>
      <!-- boardView-Area -->

      <!--------------------------------------------------[           덧글 입 출력 창           ]-------------------------------------------------------------------------->
      <!--------------------------------------------------[        board-view--replyBox        ]-------------------------------------------------------------------------->
      <article class="board-view--replyBox">
        <ul id="reply-container" th:if="${replysList} != null">
          <li th:Each="item:${replysList}" class="reply">
            <!-- <p th:text="${item.replyNo}"></p> -->
            <span
              th:if="${item.replyLevel} > 0"
              th:each="num : ${#numbers.sequence(0, item.replyLevel-1)}"
              style="display: block; width: 10px"
            ></span>
            <div
              class="reply-contents"
              th:if="${item.replyHidden == 0}
           or (${session.loggedUser != null ? session.loggedUser.userID == item.replyAuthID : false})
           or (${session.loggedUser != null ? session.loggedUser.userNM == boardDto.postAuth : false})"
            >
              <div class="reply-contents--icon">
                <a th:href="@{|/member/user/${item.replyAuthID}|}">
                  <!-- th:src="@{/upload/}+${item.replyIcon}" -->
                  <img
                    src="/images/sampleprofile.jpg"
                    alt=""
                    style="width: 30px; height: 30px; border-radius: 5px"
                  />
                  <span th:text="${item.replyAuthNM}">홍길동</span>
                </a>
                <span class="menuBtn">...</span>
                <div class="reply-contents--text">
                  <p
                    th:if="${item.replyGroup!=0}"
                    th:text="${item.replyGroup}+'덧글에게 답변'"
                    style="color: #777"
                  ></p>
                  <p th:text="${item.replyCont}">덧글 내용</p>
                </div>
                <div class="reply-contents--box">
                  <div class="reply-date" th:text="${item.replyDate}">
                    작성일자
                  </div>
                  <div
                    class="reply-contents--btns"
                    th:if="${item.replyHidden == 0}
                or (${session.loggedUser != null ? session.loggedUser.userID == item.replyAuthID : false})
                or (${session.loggedUser != null ? session.loggedUser.userNM == boardDto.postAuth : false})"
                  >
                    <span
                      id="replyReplyBtn"
                      class="replyReplyBtn"
                      th:data-replyno="${item.replyNo}"
                      >답글쓰기</span
                    >
                    <th:block
                      th:if="${session.loggedUser != null ? session.loggedUser.userID == item.replyAuthID : false}"
                    >
                    </th:block>
                  </div>
                </div>
              </div>

              <!-- 모바일 -->
              <div class="reply-date-md500">
                <div class="reply-date" th:text="${item.replyDate}">
                  작성일자
                </div>
                <div
                  class="reply-contents--btns"
                  th:if="${item.replyHidden == 0}
              or (${session.loggedUser != null ? session.loggedUser.userID == item.replyAuthID : false})
              or (${session.loggedUser != null ? session.loggedUser.userNM == boardDto.postAuth : false})"
                >
                  <span
                    id="replyReplyBtn"
                    class="replyReplyBtn replyReplyBtn-M"
                    th:data-replyno="${item.replyNo}"
                    >답글쓰기</span
                  >
                  <th:block
                    th:if="${session.loggedUser != null ? session.loggedUser.userID == item.replyAuthID : false}"
                  >
                  </th:block>
                </div>
              </div>
            </div>
            <div
              class="reply-contents reply-hidden"
              th:if="${item.replyHidden != 0} and (${session.loggedUser == null ? true : session.loggedUser.userID == item.replyAuthID ? false : session.loggedUser.userNM == boardDto.postAuth ? false : true})"
            >
              <div class="reply-contents--icon"></div>
              <span class="reply-contents--text">비공개 덧글입니다.</span>
            </div>
          </li>
        </ul>
        <div class="board-view--replyBox__input">
          <input type="checkbox" class="check-hidden" />
          <span>비밀글로 작성하기</span>
          <textarea
            class="replyCont"
            name="replyCont"
            th:value="${session.loggedUser == null ? '로그인 해 주세요' : '' }"
            rows="10"
          >
          </textarea>
          <input type="button" class="btn-primary btn-reply" value="작성" />
        </div>
        <div class="board-view--replyBox__input board-view--replyBox__input-M">
          <input
            type="button"
            class="replyCont"
            name="replyCont"
            th:value="${session.loggedUser == null ? '로그인 해 주세요' : '' }"
          />
          <!-- <input type="button" class="btn-primary btn-reply" value="작성"/> -->
          <!-- <input type="checkbox" class="check-hidden"><span>비밀글로 작성하기</span> -->
        </div>
      </article>
      <!-- board-view--textBox -->
    </section>
    <!-- boardView -->
    <!-- board-view--subPage -->

    <!--------------------------------------------------[               모달 영역             ]-------------------------------------------------------------------------->

    <section>
      <!-- 모달 섹션 -->>
      <!-- 삭제 모달창 -->
      <div id="deleteModal" class="modal-wnd">
        <div class="modal-wnd-item">
          <div class="modal-content">
            <!-- 모달창 안에 여기 내용 작성 -->
            <h3>정말로 삭제하시겠습니까?</h3>
            <button id="btnDeleteConfirm">확인</button>
            <button id="closeDeleteModal">취소</button>
          </div>
          <!-- ModalThis-content -->
        </div>
        <!-- write-modal--item -->
      </div>

      <!-- 공유 모달창 -->
      <div id="shareModal" class="modal-wnd">
        <div class="modal-wnd-item">
          <button id="closeShareModal">닫기</button>
          <div class="modal-content">
            <!-- 모달창 안에 여기 내용 작성 -->
            <div>
              <input
                type="text"
                class="shareUrl"
                th:value="'https://youtu.be/' + ${boardDto.postLink}"
                readonly
              />
              <button onclick="copyUrl();">복사</button>
              <button class="shareTwitter">트위터로 공유</button>
              <button class="shareFacebook">페이스북으로 공유</button>
              <button class="shareKakaoTalk">카카오톡으로 공유</button>
            </div>
          </div>
          <!-- ModalThis-content -->
        </div>
        <!-- write-modal--item -->
      </div>
      <!-- write-modal -->

      <!-- 덧글 삭제 모달창 -->
      <div id="deleteReplyModal" class="modal-wnd">
        <div class="modal-wnd-item">
          <div class="modal-content modal-ReplyDelete">
            <!-- 모달창 안에 여기 내용 작성 -->
            <h3>정말로 삭제하시겠습니까?</h3>
            <button id="deleteReplyConfirm">확인</button>
            <button id="closeDeleteReply">취소</button>
          </div>
          <!-- ModalThis-content -->
        </div>
        <!-- write-modal--item -->
      </div>

      <!-- 모바일 덧글 삭제 모달창 -->
      <div id="deleteReplyModal-M" class="modal-wnd">
        <div class="modal-wnd-item">
          <div class="modal-content modal-ReplyDelete">
            <!-- 모달창 안에 여기 내용 작성 -->
            <h3></h3>
            <button id="">수정</button>
            <button id="">삭제</button>
            <button id="closeDeleteReply">확인</button>
          </div>
          <!-- ModalThis-content -->
        </div>
        <!-- write-modal--item -->
      </div>

      <!-- 덧글 모달창 -->
      <div id="comReplyModal-M" class="modal-wnd">
        <div class="modal-wnd-item">
          <div class="modal-content modal-ReplyDelete">
            <!-- 모달창 안에 여기 내용 작성 -->
            <h3 style="color: black">덧글 쓰기</h3>

            <button id="closeDeleteReply">확인</button>
          </div>
          <!-- ModalThis-content -->
        </div>
        <!-- write-modal--item -->
      </div>
    </section>

    <!--------------------------------------------------[            자바 스크립트 영역             ]-------------------------------------------------------------------------->

    <script src="/js/board/replys.js"></script>
    <script src="/js/board/view.js"></script>
    <script defer>
      addReplyEvent(); // 덧글 입력 버튼 클래스명 btn-reply 고정
      addReplyReplyEvent(); // 덧글의 덧글 입력 버튼 클래스명 replyReplyBtn 고정
      addDeleteReplyEvent(); //덧글 삭제 버튼 아이디 deleteReplyBtn 고정
      modalReplyDelete(); // 덧글 삭제 확인 모달 확인 버튼 아이디 deleteReplyConfirm 고정
    </script>
    <script>
      getModal($("#deleteModalBox"), $("#deleteModal"), $("#closeDeleteModal"));
      getModal($("#shareModalBox"), $("#shareModal"), $("#closeShareModal"));
      getModal(
        $("#deleteReplyBtn"),
        $("#deleteReplyModal"),
        $("#closeDeleteReply")
      );
      getModal(
        $(".menuBtn"),
        $("#deleteReplyModal-M"),
        $("#deleteReplyModal-M  #closeDeleteReply")
      );
      getModal(
        $(".board-view--replyBox__input-M"),
        $("#comReplyModal-M"),
        $("#comReplyModal-M  #closeDeleteReply")
      );

      // 복사 버튼 누르면 url 복사
      async function copyUrl() {
        const shareUrl = $(".shareUrl").val();
        await navigator.clipboard.writeText(shareUrl);
      }

      // 트위터 공유
      $(".shareTwitter").on("click", function () {
        const sendText = "테스트 중";
        const pageUrl = encodeURIComponent(
          "https://github.com/mbelDev/sharemusic"
        );
        window.open(
          `https://twitter.com/intent/tweet?text=${sendText}&url=${pageUrl}`
        );
      });

      // 페이스북 공유
      $(".shareFacebook").on("click", function () {
        const pageUrl = encodeURIComponent(
          "https://github.com/mbelDev/sharemusic"
        );
        window.open(`http://www.facebook.com/sharer/sharer.php?u=${pageUrl}`);
      });

      // 카카오톡 공유
      Kakao.init("8d6a18d8dcc3f8eea775c4c852f086c0");
      $(".shareKakaoTalk").on("click", function () {
        Kakao.Link.sendDefault({
          objectType: "feed",
          content: {
            title: "", // 제목
            description: "", // 설명
            imageUrl: "", // 이미지 도메인
            link: {
              webUrl: "", // 웹 링크
            },
          },
          buttons: [
            {
              title: "자세히 보기",
              link: {
                webUrl: "", // 웹 링크
              },
            },
          ],
        });
      });
    </script>
    <script th:inline="javascript">
      //좋아요 History 연동 함수 #권인호 작성
      function updateLike(item){
        const postNo = $(item).data('postno');

        $.ajax({
          url:"/member/like",
          type:"POST",
          data:{
            postNo: postNo
          },
          success:function(response){
            switch(response){
              case -1 : alert("로그인 정보가 업써용 여따가 당신 이름 석쟈만 적어쥬세용")
                break;
              case 0 : alert("좋았었습니다!!")
                break;
              case 1 : alert("좋아요!")
                break;
            }
          },
          error:function(err){
            console.log(err);
            alert("로그인 정보가 업써요. 로그인 해 주셰용. 여기다 당신 이름 석 자만 적어쥬셰용.");
          }
        })
        .done(()=>{
          reloadData(postNo);
        })
      }

      //좋아요 완료 후 숫자 변경 #권인호
      function reloadData(_postNo){
        $.ajax({
          url:"/board/getLike",
          type:"POST",
          data:{
            postNo: _postNo
          },
          success:function(response){
            $(".postLike").text(response);
          },
          error:function(err){
            console.log(err);
            alert("뭔가 심상치않은 일이 생긴거야.");
            location.href="redirect:/uri";
          }
        })
      }

      /*<![CDATA[*/
      const postNo = [[${boardDto.postNo}]];
      const postLike = $(".postLike").text();

        // 추천 수 누를 때 이벤트
        function postGood() {
          console.log("btnPostLikeClicked");
          const sendData = {
            postNo: postNo
          }

          $.ajax({
            url: "/board/updateLike",
            type: "POST",
            data: sendData,
            success: function(response) {
              if (response.result != null) {
                $(".postLike").text(response.postLike);
              }
            },
            error: function(err) {
              console.log(err);
            }
          })
        }

        $("#btnDeleteConfirm").on("click", function() {
          console.log("btnDeleteClicked");
          $.ajax({
            url: "/board/delete",
            type: "POST",
            data: {"postNo": postNo},
            success: function(response) {
              if (response.msg == "ok") {
                 location.href="/mainPage/";
              } else {
                location.reload();
              }
            }
          })
        })

      /*]]>*/
    </script>
  </main>
</html>
